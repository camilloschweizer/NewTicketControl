<html>
<head>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@zendeskgarden/css-bedrock@7.0" type="text/css">
</head>
<body>
  <section data-main>Loading...</section>
  <!-- https://github.com/zendesk/zendesk_app_framework_sdk -->
  <script type="text/javascript" src="https://static.zdassets.com/zendesk_app_framework_sdk/2.0/zaf_sdk.min.js"></script>
  <script>
    // Initialise the Zendesk JavaScript API client
    // https://developer.zendesk.com/apps/docs/apps-v2


	var portal = client.get('currentAccount.subdomain');
	var seite = '';

	if (portal.indexOf("digitec.ch") >= 0) {
    	seite = 'digitec.ch';
  	}
  	else if (window.location.hostname.indexOf("galaxus.ch") >= 0) {
    	seite = 'galaxus.ch';
  	}
  	else{
    	seite = 'galaxus.de';
  	}

	console.log(seite);


	
    var client = ZAFClient.init();
	var user;
	var group;
	var assignee;
	
    function renderText(text) {
      var mainSectionEl = document.querySelector('section[data-main]');
      mainSectionEl.innerText = text;
    }
	
    function getCurrentUser() {
      return client.get('currentUser').then(function(data) {
        return data['currentUser'];
      });
    }
	
	function getTicket() {
		return client.get('ticket').then(function(data){
			return data['ticket'];
			});
	}

	function getUser() {	
		return client.get('currentUser').then(function(data){
			return client.request(`/api/v2/users/${data.currentUser.id}`)
			});	
				
	}
	
	function assignTicket() {  		
		
		getUser().then(function(data){
			user = data.user.id;
			group = data.user.default_group_id;
		
		getTicket().then(function(ticket) {
			if( typeof ticket.assignee.user != 'undefined' && ticket.assignee.user != null){
				assignee = ticket.assignee.user.id;
				console.log('Assignee already set ------- UserID: ' + user + ' Assignee: ' + assignee + ' Group: ' + group);
				} else {
					client.set('ticket.assignee', { userId: user , groupId: group });
					console.log('New Assignee set ------- UserID: ' + user + ' Assignee: ' + assignee + ' Group: ' + group);
				}        
		});        
      });    
    }
	
	function changeRecipient() {
	
    getUser().then(function(data){
	mail = data.user.user_fields.absender_mailadresse;
	console.log(mail);
	
	client.set('ticket.recipient', mail);
	});	
    }
	
	
    client.on('app.registered', function() {
	assignTicket();
	changeRecipient();
	  
    });
  </script>
</body>
</html>